(function(){var g=$("#accommodation_type_id");var e=$("#from_date");var a=$("#to_date");var f=$("#schedule-modal");var d;function c(k){this.$e=k;this.updateScrollBound=this.updateScroll.bind(this);this.taskElements=[];this.$e.append(this.$container=$("<div>",{css:{display:"none"}}));this.$e.append(this.$loadingFade=$("<div>",{"class":"schedule-loading-fade"}));this.$e.append(this.$indicator=b());this.refreshHandle=null;this.refreshInterval=3600000;this.updateDates();this.bindEvents();this.autoscrollRef=null;if(!this.scrolled&&window.location.hash){var n=window.location.hash.replace(/^#/,"");if(n.indexOf("=")>=0){var m=n.split("&");var j=[];for(var l=0;l<m.length;l++){var h=m[l].indexOf("=");j[m[l].substr(0,h)]=m[l].substr(h+1)}if(j.ref){this.autoscrollRef=j.ref}}}this.requestData();$(".tip-bottom").tooltip({placement:"bottom",trigger:"hover",container:"body"});this.$e.on("mousewheel DOMMouseScroll",function(o){var q=o.originalEvent,p=q.wheelDelta||-q.detail;var i=q.wheelDeltaX;if(i===undefined||i==0){this.scrollTop+=(p<0?1:-1)*20;o.preventDefault()}else{this.scrollLeft+=(p<0?1:-1)*20;o.preventDefault()}});this.$e.on("touchmove",function(i){i.preventDefault()})}function b(){return $("<div>",{"class":"loading-indicator"})}c.prototype.updateDates=function(){a.datepicker("setStartDate",e.val());e.datepicker().on("changeDate",function(h){a.datepicker("setStartDate",e.val())})};c.prototype.build=function(l){this.$container.empty();d=l.can_create;if(l){this.data=l}else{l=this.data}this.start=moment(l.from_date,"YYYY-MM-DD");this.end=moment(l.to_date,"YYYY-MM-DD");this.gridWidth=l.dates.length;this.gridHeight=l.users.length;this.$container.append(this.$dayHeaders=this.createDayHeaders(l.days,l.day_width));this.$container.append(this.$headers=this.createHeaders(l.dates));this.$container.append(this.$user_headers=this.createUserHeaders(l.users));this.$container.append(this.$grid=this.createGrid());this.cellWidth=this.$headers.find(".schedule-header:eq(0)").outerWidth();this.cellHeight=this.$user_headers.find(".schedule-user-header:eq(0)").outerHeight();this.$dayHeaders.css({width:this.cellWidth*(this.gridWidth)});this.$headers.css({width:this.cellWidth*(this.gridWidth)});this.$grid.css({width:this.cellWidth*this.gridWidth,height:this.cellHeight*this.gridHeight});this.$container.append(this.$tasks=this.createTasksOverlay(l.tasks,l.dates,l.days,l.day_width));this.$tasks.css({width:this.cellWidth*this.gridWidth,height:this.cellHeight*this.gridHeight});this.$container.append(this.$corner=$("<div>",{"class":"schedule-corner"}));this.bindOverlayEvents();this.$indicator.fadeOut();this.$loadingFade.fadeOut();this.$container.fadeIn();if(this.autoscrollRef&&!this.scrolled){var i=this.getTaskByRef(this.autoscrollRef);var m=$('#task-schedule [data-task-id="'+i.id+'"]');if(!m.hasClass("schedule-task-justedited")){m.addClass("schedule-task-justedited");m.hover(function(){$(this).removeClass("schedule-task-justedited")})}var n=moment(i.from_date,"YYYY-MM-DD");var h=moment(i.to_date,"YYYY-MM-DD");var k=n.diff(this.start,"days")+1;var j=h.diff(n,"days");this.$e.scrollTop(Math.max(0,this.getUserIndex(i.user_id)*this.cellHeight-this.$e.height()/2));this.$e.scrollLeft(Math.max(0,(k*this.cellWidth+(j*this.cellWidth)/2))-this.$e.width()/2);this.scrolled=true}};c.prototype.getTaskByRef=function(j){for(var h=0;h<this.data.tasks.length;h++){if(this.data.tasks[h].id==j){return this.data.tasks[h]}}return null};c.prototype.update=function(h){if(!h){h=this.data}d=h.can_create;this.$tasks.remove();this.$container.append(this.$tasks=this.createTasksOverlay(h.tasks,h.dates,h.days,h.day_width));this.$tasks.css({width:this.cellWidth*this.gridWidth,height:this.cellHeight*this.gridHeight});this.bindOverlayEvents();if(this.scrollpos!==undefined){$("#task-schedule").scrollLeft(this.scrollpos[0]);$("#task-schedule").scrollTop(this.scrollpos[1])}this.$indicator.fadeOut();$(".tip-bottom").tooltip({placement:"bottom",trigger:"hover",container:"body"})};c.prototype.createDayHeaders=function(n,k){var m=$("<div>",{"class":"schedule-headers-days"});for(var j=0;j<n.length;j++){var h=moment(n[j],"YYYY-MM-DD");var l=["schedule-header","tip-bottom"];m.append($("<div>",{"class":l.join(" "),html:"<strong>"+h.format("dddd, MMM DD")+"</strong>",width:k*50+"px"}))}return m};c.prototype.createHeaders=function(m){var l=$("<div>",{"class":"schedule-headers"});for(var j=0;j<m.length;j++){var h=moment(m[j],"YYYY-MM-DD hh:mm");var k=["schedule-header","tip-bottom"];if(h.format("HH:mm")===this.data.dayStart){k.push("schedule-header-daystart")}l.append($("<div>",{"class":k.join(" "),html:h.format("HH:mm")}))}return l};c.prototype.createUserHeaders=function(n){var m=$("<div>",{"class":"schedule-user-headers"});this.user_indexes={};var k=n.slice(0);for(var l=0;l<k.length;l++){var j=$("<div>",{"class":"tip-bottom schedule-user-header",text:k[l].name});j.css({background:k[l].colour,color:this.colorForBackground(k[l].colour)});var h="<div class='tooltip-data'>";h+="<h4>"+k[l].name+"</h4>";h+="<p>Group: "+k[l].group+"</p>";h+="<p>Active: "+k[l].active+"</p>";h+="</div>";j.attr("data-toggle","tooltip");j.attr("data-placement","bottom");j.attr("data-html","true");j.attr("data-original-title",h);m.append(j);this.user_indexes[k[l].id]=l}return m};c.prototype.brightness=function(i){if(typeof i==="undefined"){return 255}i=parseInt(i.substr(1),16);var k=(i&16711680)>>16;var j=(i&65280)>>8;var h=(i&255);return Math.sqrt(k*k*0.299+j*j*0.587+h*h*0.114)};c.prototype.lighten=function(l){var h=this.brightness(l);if(l==undefined){return}l=parseInt(l.substr(1),16);var p={};p.r=(l&16711680)>>16;p.g=(l&65280)>>8;p.b=(l&255);var m=[];var n=0;for(var i in p){p[i]+=255-h;if(p[i]>255){p[i]=255}n+=p[i]}var o=n/3;for(var i in p){if(p[i]>o){p[i]-=(p[i]-o)/3}else{if(p[i]<o){p[i]-=(p[i]-o)/1.2}}m.push(parseInt(Math.round(p[i])))}return"rgb("+m.join(",")+")"};c.prototype.colorForBackground=function(i){var j="#000000";var h="#ffffff";if(!i){return j}return this.brightness(i)<130?h:j};c.prototype.createGrid=function(){var h=$("<div>",{"class":"schedule-grid"});return h};c.prototype.createTasksOverlay=function(G,N,m,D){var o=this;var J=$("<div>",{"class":"schedule-tasks-overlay"});this.taskElements=[];for(var Q=0;Q<G.length;Q++){if(!G[Q].user_id){continue}var l=this.getUserIndex(G[Q].user_id);if(l===null){continue}var P=$("<div>",{"class":"tip-bottom schedule-task "+G[Q].status});this.taskElements[G[Q].id]=P;P.data("taskId",G[Q].id);P.attr("data-task-id",G[Q].id);var C=moment(G[Q].from_date,"YYYY-MM-DD hh:mm");var x=moment(G[Q].to_date,"YYYY-MM-DD hh:mm");var y=C.diff(N[Object.keys(N)[0]],"hours")+1;if(y>D){var p=moment(N[Object.keys(N)[0]],"YYYY-MM-DD hh:mm");var q=p.diff(this.start,"hours");var E=y+q;var B=Math.floor(y/24)+1;y=E-((B-1)*24)-q+(B-1)*D}var M=x.diff(C,"hours")-1;P.css({left:y*this.cellWidth,top:l*this.cellHeight,width:M*this.cellWidth});var k=G[Q].task_name;P.append($("<span>",{text:k}));if((y*this.cellWidth+5)<0){console.log("***");$("span",P).css({"margin-left":(-(y*this.cellWidth))+5+"px","max-width":(M*this.cellWidth)+(y*this.cellWidth)-5+"px"})}var n="<div class='tooltip-data'>";n+="<h4>User "+G[Q].user_name+"</h4>";n+="<p>Task name: <span class='text-warning'> "+G[Q].task_name+"</span></p>";n+="<p>Status: "+G[Q].tooltip_data.status+"</p>";n+="<p>Start: "+G[Q].tooltip_data.start_date+"<span class='text-info'> "+G[Q].tooltip_data.start_time+"</span></p>";n+="<p>End: "+G[Q].tooltip_data.end_date+"<span class='text-info'> "+G[Q].tooltip_data.end_time+"</span></p>";n+="</div>";P.attr("data-toggle","tooltip");P.attr("data-placement","bottom");P.attr("data-html","true");P.attr("data-original-title",n);J.append(P)}var z=this.data.non_business_periods;var h=this.data.users.slice(0);var I=e.val();I=moment(I,"DD-MMM-YYYY hh:mm");var K=a.val();K=moment(K,"DD-MMM-YYYY hh:mm").endOf("day");var T=I.diff(I,"hours");var r=K.diff(I,"hours")+1;for(var O=0;O<h.length;O++){var F=h[O];if(F.disabled==1){var L="";var R=$("<div>",{"class":"schedule-task disabled "+L});R.css({left:T*this.cellWidth,top:this.getUserIndex(F.id)*this.cellHeight,width:r*this.cellWidth});if((T*this.cellWidth+5)<0){$("span",R).css({"margin-left":(-(T*this.cellWidth))+5+"px","max-width":(r*this.cellWidth)+(T*this.cellWidth)-5+"px"})}J.append(R)}if(F.id in z){var v=z[F.id];for(var S=0;S<v.length;S++){var w=v[S];var H=moment(w.from_time,"YYYY-MM-DD hh:mm"),t;t=moment(w.to_time,"YYYY-MM-DD hh:mm");var u=H.diff(this.start,"hours");var A=t.diff(H,"hours")+1;if(t>this.end){t=this.end;A=t.diff(H,"hours")}if(H<this.start){H=this.start;u=H.diff(this.start,"hours");A=t.diff(H,"hours")+1}var s=$("<div>",{"class":"schedule-task non-business"});s.css({left:u*this.cellWidth,top:this.getUserIndex(F.id)*this.cellHeight,width:A*this.cellWidth});s.append($("<span>",{text:w.reason}));if((u*this.cellWidth+5)<0){$("span",s).css({"margin-left":(-(u*this.cellWidth))+5+"px","max-width":(A*this.cellWidth)+(u*this.cellWidth)-5+"px"})}J.append(s)}}}return J};c.prototype.updateScroll=function(){if(this.$headers){var i=this.$e.scrollTop();var h=this.$e.scrollLeft();this.$dayHeaders.css({top:i});this.$headers.css({top:"31px"});this.$user_headers.css({left:h});this.$corner.css({top:i,left:h});this.$indicator.css({top:i+this.$e.height()/2,left:h+this.$e.width()/2});this.$loadingFade.css({top:i,left:h})}window.requestAnimationFrame(this.updateScrollBound)};c.prototype.getUserIndex=function(h){return this.user_indexes[h]};c.prototype.requestData=function(){var k=[];var i=g.find(":selected").val();var j=e.val();var h=a.val();$.ajax({url:"/tasks/get-schedule-tasks-ajax",method:"GET",data:{accommodation_type_id:i,from_date:j,to_date:h},async:false,success:function(l){k=l}});this.build(k)};c.prototype.bindOverlayEvents=function(){var h=this;var i=null;this.$tasks.on("mousemove",function(m){if(h.drawing_range){var j=m.clientX-h.$tasks.offset().left;var l=Math.floor(j/h.cellWidth);var k=(l-h.drawing_range_x)+1;$("#rangeview").css({width:h.cellWidth*k})}else{if(!$(m.target).is(".schedule-tasks-overlay")){var n=$(m.target).closest(".schedule-task");if(i){i.removeClass("schedule-task-hover")}i=n;i.addClass("schedule-task-hover")}else{if(i){i.removeClass("schedule-task-hover")}i=null}}});this.$tasks.on("click",function(j){if(i){window.location.href="/tasks/view?id="+i.data("taskId")}j.preventDefault()});this.$tasks.on("mouseup",function(o){if(h.drawing_range&&d==true){var n=h.gridCellToDate(h.drawing_range_x);var m=h.gridCellToUser(h.drawing_range_y);if(m.disabled==1){var l;if(m.disabled==1){l="Not allowed"}showModalMessage("Error",l);h.drawing_range=false;$("#rangeview").remove();return}var r=o.clientX-h.$tasks.offset().left;var p=Math.floor(r/h.cellWidth);var k=h.gridCellToDate(p);n=moment(n,"DD/MM/YYYY H:mm");k=moment(k,"DD/MM/YYYY H:mm");var j=n.format("H:mm");var q=k.format("H:mm");n=n.format("YYYY-MM-DD H:mm");k=k.format("YYYY-MM-DD H:mm");h.drawing_range=false;$("#rangeview").remove();setTimeout(function(){$.ajax({url:"/tasks/schedule-request-ajax",method:"GET",data:{user_id:m.id,from_date:n,to_date:k,from_date_time:j,to_date_time:q},async:false,success:function(s){if(s.date_error){showModalMessage("Error",s.date_message);return false}if(s.time_error){showModalMessage("Error",s.time_message);return false}if(s.has_conflicts==true){showModalMessage("Error",s.conflict_message);return false}if(s.under_non_business_period==true){showModalMessage("Error",s.under_non_business_period_message);return false}f.find("input[name=user_id]").val(s.form.user_id);f.find("input[name=from_date]").val(s.form.from_date);f.find("input[name=to_date]").val(s.form.to_date);f.find("#user_name").val(s.view.user_name);f.find("#start_date").val(s.view.start_date);f.find("#end_date").val(s.view.end_date);f.find("#start_time").val(s.view.start_time);f.find("#end_time").val(s.view.end_time);f.modal();return true}})},1)}});this.$tasks.on("mousedown",function(m){if(m.which!=1){m.preventDefault()}if(i){m.preventDefault()}else{h.drawing_range=true;var j=m.pageX-h.$tasks.offset().left;var n=m.pageY-h.$tasks.offset().top;var k=Math.floor(j/h.cellWidth);var l=Math.floor(n/h.cellHeight);h.drawing_range_x=k;h.drawing_range_y=l;h.$tasks.append('<div id="rangeview"></div>');$("#rangeview").css({position:"absolute",left:k*h.cellWidth+"px",top:l*h.cellHeight+"px",width:h.cellWidth+"px",height:h.cellHeight+"px",opacity:0.3})}})};c.prototype.bindEvents=function(){this.refreshHandle=setInterval(this.refresh.bind(this),this.refreshInterval);window.requestAnimationFrame(this.updateScrollBound)};c.prototype.refresh=function(){this.$indicator.fadeIn();this.scrollpos=[$("#task-schedule").scrollLeft(),$("#task-schedule").scrollTop()];var k=[];var i=g.find(":selected").val();var j=e.val();var h=a.val();$.ajax({url:"/tasks/get-schedule-tasks-ajax",method:"GET",data:{accommodation_type_id:i,from_date:j,to_date:h},async:false,success:function(l){k=l}});this.update(k)};c.prototype.gridCellToUser=function(h){return this.data.users[h]};c.prototype.gridCellToDate=function(h){return moment(this.data.dates[h],"YYYY-MM-DD hh:mm").format("DD/MM/YYYY H:mm")};$(function(){var h=$("#task-schedule");if(h.length===0){return}window.scheduleView=new c(h)})})();